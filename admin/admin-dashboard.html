<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - CDFI Fund</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-blue: #395777;
            --dark-blue: #2b4661;
            --sidebar-width: 280px;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .header {
            background-color: var(--primary-blue);
        }
        /* Desktop: Sidebar takes fixed width and stays visible */
        .sidebar {
            background-color: var(--dark-blue);
            width: var(--sidebar-width);
            min-height: calc(100vh - 60px); 
            flex-shrink: 0;
        }

        /* Mobile: Sidebar is fixed, initially hidden, and covers the screen height */
        @media (max-width: 767px) {
            .sidebar {
                position: fixed;
                top: 60px; /* Below header */
                left: 0;
                height: calc(100vh - 60px);
                overflow-y: auto;
                transform: translateX(-100%);
                transition: transform 0.3s ease-in-out;
                z-index: 20;
            }
            .sidebar.open {
                transform: translateX(0);
            }
            .content-area-pushed {
                /* No need to push content on mobile since sidebar is fixed overlay */
                margin-left: 0;
            }
        }
        
        /* Desktop: Main content area pushes over */
        @media (min-width: 768px) {
            .sidebar {
                display: block !important; /* Ensure it overrides any hidden mobile state */
            }
            .content-area-pushed {
                margin-left: 0; /* Sidebar is now part of the flex layout */
            }
        }

        /* Custom form focus styling */
        .focus-ring-primary:focus, 
        input:focus, 
        select:focus,
        textarea:focus {
            outline: none;
            border-color: var(--primary-blue) !important;
            box-shadow: 0 0 0 1px var(--primary-blue) !important; 
        }
        /* Style for required select arrow */
        select {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='none' stroke='%234b5563'%3e%3cpath d='M7 7l3 3 3-3m0 6l-3-3-3 3' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem;
        }
        .loading-text {
            color: var(--primary-blue);
        }
    </style>
</head>
<body>

    <header id="main-header" class="header shadow-md h-[60px] fixed w-full top-0 left-0 z-30">
        <div class="container mx-auto px-4 py-3 flex items-center justify-between h-full">
            <div class="flex items-center space-x-3">
                <img src="https://placehold.co/40x40/395777/ffffff?text=DHHS" alt="DHHS Fund Logo Placeholder" class="h-8 w-8 rounded-full bg-white p-1">
                <span class="text-sm md:text-xl font-bold text-white hidden sm:block">CDFI ADMIN PORTAL</span>
            </div>

            <button id="menu-toggle" class="md:hidden text-white p-2 focus:outline-none rounded-lg hover:bg-[var(--dark-blue)] transition duration-200">
                <svg id="menu-icon-open" class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
                <svg id="menu-icon-close" class="h-6 w-6 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
            
            <div class="hidden md:flex items-center space-x-4">
                <span class="text-sm text-white">Welcome, Admin!</span>
                <button id="logout-btn" class="px-3 py-1 bg-red-500 text-white text-sm font-medium rounded-lg hover:bg-red-600 transition duration-200 shadow-lg">
                    Logout
                </button>
            </div>
        </div>
    </header>

    <div class="flex pt-[60px] min-h-screen">
        
        <aside id="sidebar" class="sidebar text-white p-4 flex-shrink-0">
            <h3 class="text-lg font-semibold border-b border-gray-700 pb-3 mb-4 mt-2">Navigation</h3>
            <nav class="space-y-2">
                
                <a href="#" class="nav-link block p-3 rounded-lg hover:bg-gray-700 transition duration-200 flex items-center space-x-3 bg-gray-700" data-view="dashboard">
                    <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 8v8m-4-4v4m-4-4v4M4 20h16a2 2 0 002-2V6a2 2 0 00-2-2H4a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                    <span>Dashboard Home</span>
                </a>

                <a href="#" id="public-display-link" class="nav-link block p-3 rounded-lg hover:bg-gray-700 transition duration-200 flex items-center space-x-3" data-view="manage-public-display">
                    <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-4m0 0l3-3m0 0l3 3m-3-3v7m6-7a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    <span>Public Display Management</span>
                </a>

                <a href="#" class="nav-link block p-3 rounded-lg hover:bg-gray-700 transition duration-200 flex items-center space-x-3" data-view="manage-winners">
                    <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                    <span>Manage Winner Data</span>
                </a>

            </nav>
        </aside>
        
        <main id="content-area" class="flex-grow p-6 transition-all duration-300 content-area-pushed">
            
            <section id="view-dashboard" class="content-view">
                <h2 class="text-3xl font-extrabold text-gray-800 mb-6">Dashboard Overview</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="bg-white p-6 rounded-xl shadow-md border-t-4 border-[var(--primary-blue)]">
                        <p class="text-sm font-medium text-gray-500">Total Awardees</p>
                        <p id="total-awardees" class="text-4xl font-bold text-[var(--dark-blue)] mt-1">...</p>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-md border-t-4 border-green-500">
                        <p class="text-sm font-medium text-gray-500">Published Records</p>
                        <p id="published-records" class="text-4xl font-bold text-green-700 mt-1">...</p>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-md border-t-4 border-yellow-500">
                        <p class="text-sm font-medium text-gray-500">Draft Records</p>
                        <p id="draft-records" class="text-4xl font-bold text-yellow-700 mt-1">...</p>
                    </div>
                </div>
                
                <div class="bg-white p-6 rounded-xl shadow-md mt-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Quick Actions</h3>
                    <p class="text-gray-600">Use the sidebar to navigate specific management tools. Use "Manage Winner Data" to view all records and edit them.</p>
                </div>
            </section>

            <section id="view-manage-public-display" class="content-view hidden">
                <h2 class="text-3xl font-extrabold text-gray-800 mb-6">Public Display Management</h2>
                <div class="bg-white p-6 rounded-xl shadow-2xl">
                    <h3 id="form-title" class="text-2xl font-bold text-[var(--primary-blue)] mb-6 border-b pb-3">Create New Winner Profile</h3>
                    
                    <form id="winner-profile-form" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        
                        <input type="hidden" id="winner-id" name="winner-id" value="">

                        <div class="col-span-1">
                            <label for="winner-name" class="block text-sm font-medium text-gray-700 mb-1">Winner Name</label>
                            <input type="text" id="winner-name" name="winner-name" required placeholder="John Doe Community Center"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus-ring-primary transition">
                        </div>

                        <div class="col-span-1">
                            <label for="winner-location" class="block text-sm font-medium text-gray-700 mb-1">Location (City, State)</label>
                            <input type="text" id="winner-location" name="winner-location" required placeholder="New York, NY"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus-ring-primary transition">
                        </div>

                        <div class="col-span-1">
                            <label for="winning-code" class="block text-sm font-medium text-gray-700 mb-1">Winning Code/ID</label>
                            <input type="text" id="winning-code" name="winning-code" required placeholder="DHHS-2024-54321"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus-ring-primary transition">
                        </div>

                        <div class="col-span-1">
                            <label for="social-link" class="block text-sm font-medium text-gray-700 mb-1">Social Profile Link (Optional)</label>
                            <input type="url" id="social-link" name="social-link" placeholder="https://www.facebook.com/winner"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus-ring-primary transition">
                        </div>
                        
                        <div class="col-span-1">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Winning Amount</label>
                            <div class="flex space-x-2">
                                <input type="text" id="winning-currency" name="winning-currency" required placeholder="$" value="$"
                                    class="w-1/4 px-4 py-2 border border-gray-300 rounded-lg focus-ring-primary transition text-center" maxlength="4">
                                <input type="number" id="winning-amount" name="winning-amount" required min="0" step="1" placeholder="500000"
                                    class="w-3/4 px-4 py-2 border border-gray-300 rounded-lg focus-ring-primary transition">
                            </div>
                        </div>
                        
                        <div class="col-span-1">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Payment Fee</label>
                            <div class="flex space-x-2">
                                <input type="text" id="fee-currency" name="fee-currency" required placeholder="$" value="$"
                                    class="w-1/4 px-4 py-2 border border-gray-300 rounded-lg focus-ring-primary transition text-center" maxlength="4">
                                <input type="number" id="payment-fee" name="payment-fee" required min="0" step="1" placeholder="500"
                                    class="w-3/4 px-4 py-2 border border-gray-300 rounded-lg focus-ring-primary transition">
                            </div>
                        </div>

                       <div class="col-span-1">
                        <label for="winner-status" class="block text-sm font-medium text-gray-700 mb-1">Public Display Status</label>
                          <input type="text" id="winner-status" name="winner-status" required 
                             placeholder="e.g., published, draft, featured"
                          class="w-full px-4 py-2 border border-gray-300 rounded-lg focus-ring-primary transition">
                        </div>

                       <div class="col-span-1">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Winner Profile Image</label>
    
                        <img id="image-preview" 
                        class="h-20 w-20 rounded-full object-cover mb-3 border border-gray-300 shadow-sm" 
                        src="default-avatar.png" 
                         alt="Profile Preview"> 
    
                        <input type="file" 
                          id="image-upload-input" 
                         name="winner-image" 
                        accept="image/png, image/jpeg"
                     onchange="previewImage(event)"
                    class="w-full p-2 border border-gray-300 rounded-lg bg-gray-50 focus-ring-primary transition">
                    </div>

                        <div class="col-span-full pt-4">
                            <button type="submit" id="submit-button"
                                class="w-full md:w-auto px-8 py-3 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700 transition duration-300 shadow-xl">
                                Save Winner Profile
                            </button>
                            <p class="mt-2 text-sm text-gray-500">Submitting this form updates the winner record.</p>
                        </div>
                    </form>
                </div>
            </section>

            <section id="view-manage-winners" class="content-view hidden">
                <h2 class="text-3xl font-extrabold text-gray-800 mb-6">Manage Winner Data Records</h2>
                <div class="bg-white p-6 rounded-xl shadow-md">
                    <div class="flex justify-between items-center mb-4 border-b pb-4">
                        <h3 class="text-xl font-bold text-[var(--primary-blue)]">All Winner Records</h3>
                        <button onclick="createNewWinner()"
                            class="px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded-lg hover:bg-blue-700 transition duration-300 shadow-md flex items-center space-x-2">
                            <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                            <span>Add New</span>
                        </button>
                    </div>

                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200 rounded-lg overflow-hidden">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Location</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Award</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Public Status</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="winners-table-body" class="bg-white divide-y divide-gray-200">
                                <tr id="loading-row">
                                    <td colspan="6" class="p-6 text-center text-lg loading-text">Loading winner data...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>
        
        </main>
    </div>
    
    <div id="mobile-backdrop" class="fixed inset-0 bg-black bg-opacity-50 z-10 hidden md:hidden" onclick="toggleSidebar()"></div>

    <div id="custom-modal" class="hidden fixed inset-0 z-50 overflow-y-auto bg-gray-900 bg-opacity-75 flex items-center justify-center">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm m-4 transform transition-all">
            <h3 id="modal-title" class="text-xl font-bold text-[var(--primary-blue)] mb-3">Modal Title</h3>
            <p id="modal-message" class="text-gray-700 mb-6">Modal Message</p>
            <div class="flex justify-end space-x-3">
                <button id="modal-cancel-btn" class="px-4 py-2 bg-gray-300 text-gray-800 text-sm font-medium rounded-lg hover:bg-gray-400 transition duration-200 hidden">Cancel</button>
                <button id="modal-confirm-btn" class="px-4 py-2 bg-red-600 text-white text-sm font-medium rounded-lg hover:bg-red-700 transition duration-200">OK</button>
            </div>
        </div>
    </div>
<script>
    // --- Global State & API Configuration ---
    const API_BASE_URL = '/api/winners';
    const STATS_API_URL = '/api/winners/stats';
    // 🖼️ NEW UPLOAD URL
    const UPLOAD_API_URL = '/api/upload'; 
    let WINNERS_DATA = [];
    let ADMIN_TOKEN = localStorage.getItem('adminToken');

    // --- Auth & Helper Functions ---

    /**
     * Checks for token existence and redirects if unauthorized.
     * @returns {boolean} True if token exists, false otherwise.
     */
    function checkAuthAndToken() {
        if (!ADMIN_TOKEN) {
            // If token is missing or cleared, redirect to login page
            window.location.href = 'admin-login.html'; 
            return false;
        }
        return true;
    }

    /**
     * Custom fetch wrapper that includes auth token and handles 401 errors gracefully.
     * NOTE: This function correctly handles file uploads (FormData) by NOT setting 
     * 'Content-Type': 'application/json' if the body is a FormData object.
     */
    async function fetchWithAuth(url, options = {}) {
        if (!checkAuthAndToken()) {
            throw new Error("Unauthorized Access");
        }
        
        // Ensure options.headers is an object
        options.headers = options.headers || {};
        
        // Always include Authorization header
        options.headers['Authorization'] = `Bearer ${ADMIN_TOKEN}`;

        // For non-file uploads (JSON data), explicitly set Content-Type
        if (!options.body || !(options.body instanceof FormData)) {
             if (options.headers['Content-Type'] === undefined) {
                 options.headers['Content-Type'] = 'application/json';
             }
        } else {
             // CRITICAL FIX: Ensure 'Content-Type' is removed entirely for FormData 
             // so the browser can set the 'multipart/form-data' boundary.
             delete options.headers['Content-Type'];
        }
        
        const response = await fetch(url, options);

        if (response.status === 401) {
            // Token invalid or expired - redirect to login
            localStorage.removeItem('adminToken');
            showModal('Session Expired', 'Your session has expired. Please log in again.', 'alert', () => {
                window.location.href = 'admin-login.html';
            });
            throw new Error("Unauthorized - Session Expired");
        }
        if (!response.ok) {
            const errorBody = await response.json().catch(() => ({ message: response.statusText }));
            throw new Error(`API Error (${response.status}): ${errorBody.message || 'Unknown error'}`);
        }
        
        // Handle successful DELETE (which may return 204 No Content or similar)
        if (response.status === 204 || response.headers.get('content-length') === '0') {
            return { success: true };
        }

        return response.json();
    }
    
    // 🖼️ NEW: Function to handle file upload
    async function uploadImage(file) {
        if (!file) {
            return { imageUrl: null }; // No file selected, return null URL
        }

        const formData = new FormData();
        // The key 'winnerImage' MUST match the name used in multer.single('winnerImage') on the server.
        formData.append('winnerImage', file); 

        console.log(`[API] Attempting to upload image...`);
        
        // CRITICAL FIX: Pass 'Content-Type: undefined' to explicitly signal to 
        // fetchWithAuth to REMOVE it, forcing the browser to set the boundary.
        const response = await fetchWithAuth(UPLOAD_API_URL, {
            method: 'POST',
            // Pass the FormData object as the body
            body: formData, 
            // This is the key change: we set Content-Type to undefined here 
            // so fetchWithAuth will delete it before the final fetch call.
            headers: {
                 'Content-Type': undefined 
            }
        });

        // The response from a successful upload should contain the imageUrl
        return { imageUrl: response.imageUrl };
    }


    // --- UI & Modal Logic (Replacing alert/confirm) ---

    const modal = document.getElementById('custom-modal');
    const modalTitle = document.getElementById('modal-title');
    const modalMessage = document.getElementById('modal-message');
    const confirmBtn = document.getElementById('modal-confirm-btn');
    const cancelBtn = document.getElementById('modal-cancel-btn');
    let currentCallback = null;

    /**
     * Shows the custom modal for alerts or confirmations.
     */
    function showModal(title, message, type = 'alert', callback = null) {
        modalTitle.textContent = title;
        modalMessage.textContent = message;
        currentCallback = callback;

        if (type === 'confirm') {
            cancelBtn.classList.remove('hidden');
            confirmBtn.textContent = 'Confirm';
            confirmBtn.onclick = () => {
                modal.classList.add('hidden');
                if (currentCallback) currentCallback(true);
            };
            cancelBtn.onclick = () => {
                modal.classList.add('hidden');
                if (currentCallback) currentCallback(false);
            };
        } else { // 'alert'
            cancelBtn.classList.add('hidden');
            confirmBtn.textContent = 'OK';
            confirmBtn.onclick = () => {
                modal.classList.add('hidden');
                if (currentCallback) currentCallback();
            };
        }
        modal.classList.remove('hidden');
        modal.style.display = 'flex'; // Ensure it's visible after removing 'hidden'
    }

    // Function to toggle the mobile sidebar state
    function toggleSidebar() {
        const sidebar = document.getElementById('sidebar');
        const backdrop = document.getElementById('mobile-backdrop');
        const openIcon = document.getElementById('menu-icon-open');
        const closeIcon = document.getElementById('menu-icon-close');

        const isOpen = sidebar.classList.toggle('open');
        backdrop.classList.toggle('hidden', !isOpen);
        
        openIcon.classList.toggle('hidden', isOpen);
        closeIcon.classList.toggle('hidden', !isOpen);
    }

    // Function to handle switching between content views
    function showView(viewId) {
        const views = document.querySelectorAll('.content-view');
        const navLinks = document.querySelectorAll('.nav-link');
        
        views.forEach(view => view.classList.add('hidden'));
        navLinks.forEach(link => link.classList.remove('bg-gray-700'));

        const targetView = document.getElementById(`view-${viewId}`);
        if (targetView) {
            targetView.classList.remove('hidden');
        }
        
        const activeLink = document.querySelector(`.nav-link[data-view="${viewId}"]`);
        if (activeLink) {
            activeLink.classList.add('bg-gray-700');
        }

        // Close sidebar on mobile
        if (window.innerWidth < 768) {
            document.getElementById('sidebar').classList.remove('open');
            document.getElementById('mobile-backdrop').classList.add('hidden');
            document.getElementById('menu-icon-open').classList.remove('hidden');
            document.getElementById('menu-icon-close').classList.add('hidden');
        }
    }
    
    // --- Data Fetching and Dashboard Stats (API Integration) ---

    /**
     * Fetches all winners from the API.
     */
    async function fetchAllWinners() {
        console.log(`[API] Fetching all winners from ${API_BASE_URL}...`);
        // The JSON Content-Type will be added automatically by fetchWithAuth
        return fetchWithAuth(API_BASE_URL, {}); 
    }

    /**
     * Fetches dashboard statistics.
     */
    async function fetchDashboardStats() {
        console.log(`[API] Fetching stats from ${STATS_API_URL}...`);
        // The JSON Content-Type will be added automatically by fetchWithAuth
        return fetchWithAuth(STATS_API_URL, {}); 
    }

    // Function to update dashboard counts
    function updateDashboardStats(stats) {
        document.getElementById('total-awardees').textContent = stats.total?.toLocaleString() || '0';
        document.getElementById('published-records').textContent = stats.published?.toLocaleString() || '0';
        document.getElementById('draft-records').textContent = stats.draft?.toLocaleString() || '0';
    }

    // --- Winner Management (CRUD Integration) ---

    // Renders the data table dynamically from WINNERS_DATA
    function renderWinnersTable() {
        const tableBody = document.getElementById('winners-table-body');
        tableBody.innerHTML = ''; // Clear existing rows

        if (WINNERS_DATA.length === 0) {
             tableBody.innerHTML = `<tr><td colspan="6" class="p-6 text-center text-gray-500">No winner records found.</td></tr>`;
             return;
        }

        WINNERS_DATA.forEach(winner => {
            const status = winner.status.toLowerCase();
            let statusClass = 'text-gray-600';
            
            if (status === 'published') {
                statusClass = 'text-green-600';
            } else if (status === 'featured') {
                statusClass = 'text-blue-600';
            } else if (status === 'draft') {
                statusClass = 'text-yellow-600';
            }

            // 💰 Use the custom currency field for display
            const currencySymbol = winner.currency || '$'; 

            // 🖼️ Display winner image or a default avatar
            const imageUrl = winner.imageUrl && winner.imageUrl.trim() !== '' ? winner.imageUrl : 'default-avatar.png';
            
            const row = tableBody.insertRow();
            row.className = 'hover:bg-gray-50';
            
            row.innerHTML = `
                <td class="px-4 py-4 whitespace-nowrap text-sm">
                    <div class="flex items-center">
                        <div class="flex-shrink-0 h-10 w-10">
                            <img class="h-10 w-10 rounded-full object-cover" src="${imageUrl}" alt="Winner Profile">
                        </div>
                        <div class="ml-4">
                            <div class="text-sm font-medium text-[var(--primary-blue)]">${winner.name}</div>
                            <div class="text-xs text-gray-500">${winner._id.slice(-6)}</div>
                        </div>
                    </div>
                </td>
                <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500">${winner.location}</td>
                <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500">${currencySymbol}${winner.amount.toLocaleString()}</td>
                <td class="px-4 py-4 whitespace-nowrap text-sm ${statusClass} font-semibold">${winner.status.charAt(0).toUpperCase() + winner.status.slice(1)}</td>
                <td class="px-4 py-4 whitespace-nowrap text-sm font-medium space-x-2">
                    <button onclick="handleEdit('${winner._id}')" class="text-indigo-600 hover:text-indigo-900 text-xs font-semibold rounded-lg p-1 transition duration-150">Edit</button>
                    <button onclick="handleDeletePrompt('${winner._id}', '${winner.name}')" class="text-red-600 hover:text-red-900 text-xs font-semibold rounded-lg p-1 transition duration-150">Delete</button>
                </td>
            `;
        });
    }

    // Combined fetch and render function
    async function fetchAndRenderAllData() {
        try {
            // Set loading state
            document.getElementById('winners-table-body').innerHTML = `<tr><td colspan="6" class="p-6 text-center text-lg loading-text">Loading winner data...</td></tr>`;
            document.getElementById('total-awardees').textContent = '...';
            document.getElementById('published-records').textContent = '...';
            document.getElementById('draft-records').textContent = '...';

            // Fetch data concurrently
            const [data, stats] = await Promise.all([
                fetchAllWinners().catch(e => { console.error("Error fetching data:", e.message); return []; }),
                fetchDashboardStats().catch(e => { console.error("Error fetching stats:", e.message); return { total: 0, published: 0, draft: 0 }; })
            ]);
            
            WINNERS_DATA = data;
            
            // Render UI
            renderWinnersTable();
            updateDashboardStats(stats);

        } catch (error) {
            console.error("Critical error in fetchAndRenderAllData:", error);
            // The error is likely handled in fetchWithAuth (401 redirect)
            document.getElementById('winners-table-body').innerHTML = `<tr><td colspan="6" class="p-6 text-center text-red-500">Error: Could not load data. Check console.</td></tr>`;
        }
    }

    // Resets the form to its initial 'Create New' state
    function resetForm() {
        document.getElementById('winner-profile-form').reset();
        document.getElementById('winner-id').value = '';
        document.getElementById('form-title').textContent = 'Create New Winner Profile';
        document.getElementById('submit-button').textContent = 'Save Winner Profile';
        // Set default currency values
        document.getElementById('winning-currency').value = '$';
        document.getElementById('fee-currency').value = '$';
        
        // 🖼️ Reset Image Preview and File Input
        document.getElementById('image-preview').src = 'default-avatar.png'; 
        document.getElementById('image-upload-input').value = '';
    }

    // Prepares the form for a new entry
    window.createNewWinner = function() {
        resetForm();
        showView('manage-public-display');
        document.getElementById('form-title').textContent = 'Create New Winner Profile';
        document.getElementById('submit-button').textContent = 'Save New Winner Profile';
    }

    // Loads data into the form for editing
    window.handleEdit = function(id) {
        const winner = WINNERS_DATA.find(w => w._id === id);
        if (!winner) {
            showModal('Error', `Winner not found for ID: ${id}`, 'alert');
            return;
        }

        // Populate the form fields in the 'view-manage-public-display' section
        document.getElementById('winner-id').value = winner._id;
        document.getElementById('winner-name').value = winner.name;
        document.getElementById('winner-location').value = winner.location;
        document.getElementById('winning-code').value = winner.code;
        document.getElementById('social-link').value = winner.social || '';
        
        // 💰 Load Currency Fields
        document.getElementById('winning-currency').value = winner.currency || '$'; 
        document.getElementById('winning-amount').value = winner.amount;
        
        document.getElementById('fee-currency').value = winner.feeCurrency || '$';
        document.getElementById('payment-fee').value = winner.fee;
        
        document.getElementById('winner-status').value = winner.status;

        // 🖼️ Load Image Preview (using the existing imageUrl)
        const currentImageUrl = winner.imageUrl && winner.imageUrl.trim() !== '' ? winner.imageUrl : 'default-avatar.png';
        document.getElementById('image-preview').src = currentImageUrl;
        
        // Update the form title and button text
        document.getElementById('form-title').textContent = `Edit Winner Profile: ${winner.name}`;
        document.getElementById('submit-button').textContent = 'Update Winner Profile';

        // Switch to the form view
        showView('manage-public-display');
    }

    // Simulates API call to delete a record
    async function deleteRecord(id) {
        console.log(`[API] Attempting to DELETE record ID: ${id}...`);
        // The JSON Content-Type will be added automatically by fetchWithAuth
        await fetchWithAuth(`${API_BASE_URL}/${id}`, { 
            method: 'DELETE'
        });
        return true;
    }

    // Replaces confirm() dialog for deletion
    window.handleDeletePrompt = function(id, name) {
        showModal(
            'Confirm Deletion',
            `Are you sure you want to permanently delete the winner record for "${name}"?`,
            'confirm',
            async (confirmed) => {
                if (confirmed) {
                    try {
                        await deleteRecord(id);
                        console.log(`[SUCCESS] Deleted winner ID: ${id}`);
                        await fetchAndRenderAllData(); 
                        showModal('Success', `Successfully deleted winner: ${name}`, 'alert');
                    } catch (error) {
                        console.error("Error deleting record:", error);
                        showModal('Error', `Failed to delete winner record: ${error.message}`, 'alert');
                    }
                }
            }
        );
    }

    // Simulates API call to create or update a record
    async function createUpdateRecord(record, isUpdate) {
        const method = isUpdate ? 'PUT' : 'POST';
        const url = isUpdate ? `${API_BASE_URL}/${record.id}` : API_BASE_URL;
        
        console.log(`[API] Attempting to ${method} data to ${url}...`, record);
        
        // Payload includes new currency and imageUrl fields
        const payload = {
            name: record.name,
            location: record.location,
            code: record.code,
            social: record.social,
            amount: record.amount,
            currency: record.currency, 
            fee: record.fee,
            feeCurrency: record.feeCurrency, 
            status: record.status,
            imageUrl: record.imageUrl // 🖼️ NEW: Include the final image URL
        };

        return fetchWithAuth(url, {
            method: method,
            // Content-Type: application/json is now correctly handled/set by fetchWithAuth
            body: JSON.stringify(payload) 
        });
    }
    
    // 🖼️ NEW: Function to handle immediate image preview when file is selected
    window.previewImage = function(event) {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('image-preview').src = e.target.result;
            };
            reader.readAsDataURL(file);
        } else {
            // Revert to default if file selection is canceled/cleared
            document.getElementById('image-preview').src = 'default-avatar.png'; 
        }
    }


    // Handles the form submission (Save/Update)
    document.getElementById('winner-profile-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const submitButton = document.getElementById('submit-button');
        const originalButtonText = submitButton.textContent;
        submitButton.disabled = true;
        submitButton.textContent = 'Processing...';
        
        const id = document.getElementById('winner-id').value;
        const isUpdate = !!id;
        
        const imageInput = document.getElementById('image-upload-input');
        const file = imageInput.files[0];
        let finalImageUrl = ''; // This will hold the URL for the database

        try {
            // 1. Determine Initial Image URL (only for update)
            if (isUpdate) {
                const currentWinner = WINNERS_DATA.find(w => w._id === id);
                // Get the existing image URL if updating
                finalImageUrl = currentWinner ? currentWinner.imageUrl : ''; 
            }

            // 2. 🖼️ UPLOAD IMAGE FIRST (if a new file is selected)
            if (file) {
                submitButton.textContent = 'Uploading Image...';
                // This call is now fixed to handle FormData headers correctly
                const uploadResult = await uploadImage(file);
                // Overwrite finalImageUrl with the newly uploaded URL
                finalImageUrl = uploadResult.imageUrl;
            } 
            // If it's a new record and no file is chosen, finalImageUrl remains ''

            
            // 3. COLLECT AND SAVE RECORD DATA
            submitButton.textContent = 'Saving Profile...';
            const recordPayload = {
                id: id,
                name: document.getElementById('winner-name').value,
                location: document.getElementById('winner-location').value,
                code: document.getElementById('winning-code').value,
                social: document.getElementById('social-link').value,
                amount: parseInt(document.getElementById('winning-amount').value) || 0,
                currency: document.getElementById('winning-currency').value.trim() || '$', 
                fee: parseInt(document.getElementById('payment-fee').value) || 0,
                feeCurrency: document.getElementById('fee-currency').value.trim() || '$', 
                status: document.getElementById('winner-status').value,
                imageUrl: finalImageUrl // 🖼️ Use the uploaded URL or existing URL
            };

            await createUpdateRecord(recordPayload, isUpdate);
            
            // After submission, refresh the data and switch back to the table view
            await fetchAndRenderAllData();
            resetForm();
            showView('manage-winners'); 

            const action = isUpdate ? 'Updated' : 'Created';
            showModal('Success', `Winner profile successfully ${action}: ${recordPayload.name}.`, 'alert');

        } catch (error) {
            console.error(`Error during ${isUpdate ? 'update' : 'creation'}:`, error);
            showModal('Error', `Failed to save winner profile: ${error.message}`, 'alert');
        } finally {
            submitButton.disabled = false;
            submitButton.textContent = originalButtonText;
        }
    });


    // --- Navigation Setup & Initialization ---

    // Attach event listeners to sidebar links
    document.querySelectorAll('.nav-link').forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            const viewId = this.getAttribute('data-view');
            
            if (viewId === 'manage-public-display') {
                resetForm();
            }
            
            showView(viewId);

            // If navigating to a data view, ensure data is refreshed
            if (viewId === 'manage-winners' || viewId === 'dashboard') {
                fetchAndRenderAllData();
            }
        });
    });

    // Attach listener to mobile menu toggle
    document.getElementById('menu-toggle').addEventListener('click', toggleSidebar);

    // Logout logic
    document.getElementById('logout-btn').addEventListener('click', function() {
        showModal(
            'Logout Confirmation',
            'Are you sure you want to log out?',
            'confirm',
            (confirmed) => {
                if (confirmed) {
                    localStorage.removeItem('adminToken');
                    window.location.href = 'admin-login.html'; 
                }
            }
        );
    });

    // Initial setup on load
    window.onload = () => {
        if (checkAuthAndToken()) { // Check token before proceeding
            fetchAndRenderAllData(); // Fetch data and populate table/dashboard
            showView('dashboard'); // Start at the dashboard
        }
    };
</script>
</body>
</html>